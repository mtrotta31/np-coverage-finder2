<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NP Ninja – Roster</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#10b981',
          }
        }
      }
    }
  </script>
  <style>
    #vanta-bg { position: fixed; inset: 0; z-index: -1; opacity: .15; }
    .drawer { transition: transform .25s ease-in-out; }
    .drawer-closed { transform: translateX(100%); }
    .badge { @apply inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800; }
    .chip { @apply inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700 mr-1 mb-1; }
    th.sortable { cursor: pointer; }
    th.sortable .dir { opacity: .35; }
    th.sortable.active { color: #111827; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="vanta-bg"></div>

  <!-- NAV -->
  <nav class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center space-x-6">
          <div class="flex items-center font-bold text-xl">
            <i data-feather="users" class="mr-2 text-primary-500"></i> NP Ninja
          </div>
          <div class="hidden sm:flex sm:space-x-8">
            <a href="index.html" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Finder</a>
            <a href="roster.html" class="border-primary-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Roster</a>
            <a href="coverage.html" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Coverage</a>
          </div>
        </div>
        <div class="hidden sm:flex items-center">
          <button id="importCsvBtn" class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-md text-sm font-medium">
            <i data-feather="upload-cloud" class="inline mr-2"></i> Import CSV
          </button>
        </div>
        <div class="sm:hidden flex items-center">
          <button class="p-2"><i data-feather="menu"></i></button>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Warning banner if JSON missing -->
    <div id="warn" class="hidden mb-4 rounded-md bg-yellow-50 p-4">
      <div class="flex">
        <div class="flex-shrink-0"><i data-feather="alert-triangle" class="text-yellow-600"></i></div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-yellow-800">Using sample data</h3>
          <div class="mt-2 text-sm text-yellow-700">
            We couldn't load <code>/data/np_roster.json</code>. The page is running with a small sample dataset.
          </div>
        </div>
      </div>
    </div>

    <!-- STATS -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="stats">
      <!-- Cards injected -->
    </div>

    <!-- FILTERS -->
    <div class="bg-white shadow rounded-lg p-4 mb-6">
      <div class="flex flex-wrap gap-3 items-end">
        <div>
          <label class="block text-sm font-medium text-gray-700">States</label>
          <div id="stateFilter" class="flex flex-wrap gap-2 mt-1">
            <!-- state chips -->
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Payers</label>
          <div id="payerFilter" class="flex flex-wrap gap-2 mt-1">
            <!-- payer chips -->
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Credential</label>
          <div id="credFilter" class="flex flex-wrap gap-2 mt-1">
            <!-- credential chips -->
          </div>
        </div>
        <div class="flex-1 min-w-[220px]">
          <label class="block text-sm font-medium text-gray-700">Search</label>
          <input id="search" type="text" placeholder="Name, email, or NPI" class="mt-1 w-full rounded-md border-gray-300 focus:ring-primary-500 focus:border-primary-500">
        </div>
        <div class="flex items-center space-x-2">
          <input id="inNet" type="checkbox" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
          <label for="inNet" class="text-sm text-gray-700">In‑network confirmed only</label>
        </div>
        <div class="ml-auto flex items-center space-x-3">
          <button id="clearFilters" class="text-sm text-gray-600 hover:text-gray-900 underline">Clear all</button>
          <div class="text-sm text-gray-500" id="countLabel">Showing 0 providers</div>
        </div>
      </div>
    </div>

    <!-- BULK ACTIONS -->
    <div class="flex items-center justify-between mb-2">
      <div class="flex items-center space-x-2">
        <button id="bulkCopyEmails" class="px-3 py-2 bg-white border border-gray-300 rounded-md text-sm hover:bg-gray-50"><i data-feather="copy" class="inline mr-1"></i> Copy Emails</button>
        <button id="bulkExportCsv" class="px-3 py-2 bg-white border border-gray-300 rounded-md text-sm hover:bg-gray-50"><i data-feather="download" class="inline mr-1"></i> Export CSV</button>
      </div>
      <div class="flex items-center space-x-2">
        <label class="text-sm text-gray-600">Rows per page</label>
        <select id="pageSize" class="rounded-md border-gray-300 focus:ring-primary-500 focus:border-primary-500 text-sm">
          <option>10</option>
          <option>25</option>
          <option>50</option>
        </select>
      </div>
    </div>

    <!-- TABLE -->
    <div class="bg-white shadow rounded-lg overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10">
              <input id="selAll" type="checkbox" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
            </th>
            <th data-key="name" class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name <span class="dir">↕</span></th>
            <th data-key="statesCount" class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">States <span class="dir">↕</span></th>
            <th data-key="personalNPI" class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Personal NPI <span class="dir">↕</span></th>
            <th data-key="payersCount" class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payers <span class="dir">↕</span></th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mobile</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Availability</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody" class="bg-white divide-y divide-gray-200">
          <!-- rows -->
        </tbody>
      </table>
    </div>

    <!-- PAGINATION -->
    <div class="mt-3 flex items-center justify-between">
      <div id="rangeLabel" class="text-sm text-gray-600"></div>
      <div class="space-x-2">
        <button id="prevPage" class="px-3 py-1.5 bg-white border border-gray-300 rounded-md text-sm disabled:opacity-50">Prev</button>
        <button id="nextPage" class="px-3 py-1.5 bg-white border border-gray-300 rounded-md text-sm disabled:opacity-50">Next</button>
      </div>
    </div>
  </main>

  <!-- DETAILS DRAWER -->
  <aside id="drawer" class="drawer fixed top-0 right-0 w-full sm:w-[440px] h-full bg-white shadow-2xl drawer-closed">
    <div class="h-16 px-4 border-b flex items-center justify-between">
      <h3 class="font-semibold text-gray-800">Provider Details</h3>
      <button id="closeDrawer" class="p-2"><i data-feather="x"></i></button>
    </div>
    <div id="drawerBody" class="p-4 space-y-4 overflow-y-auto h-[calc(100%-4rem)]">
      <!-- content -->
    </div>
  </aside>

  <!-- CSV IMPORT MODAL (lightweight placeholder) -->
  <div id="csvModal" class="hidden fixed inset-0 bg-black/30 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
      <div class="p-4 border-b flex items-center justify-between">
        <h4 class="font-semibold">Import CSV (client-side)</h4>
        <button id="closeCsv" class="p-2"><i data-feather="x"></i></button>
      </div>
      <div class="p-4 space-y-3">
        <input id="csvFile" type="file" accept=".csv" class="block w-full text-sm text-gray-700"/>
        <p class="text-sm text-gray-500">Expected columns include: firstName,lastName,email,mobile,credential,states (pipe‑sep),personalNPI,payers (pipe‑sep),availability,inNetworkConfirmed</p>
        <div class="text-sm text-yellow-700 bg-yellow-50 p-2 rounded">This merges into the in-memory roster only (no server save).</div>
      </div>
      <div class="p-4 border-t flex justify-end space-x-2">
        <button id="importCsv" class="px-3 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-md text-sm">Import</button>
      </div>
    </div>
  </div>

  <footer class="bg-white mt-12">
    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-gray-500 text-sm">
      &copy; 2025 NP Ninja. All rights reserved.
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>
  <script>
    // Optional background
    try {
      VANTA.GLOBE({
        el: "#vanta-bg",
        mouseControls: true,
        touchControls: true,
        gyroControls: false,
        minHeight: 200.00,
        minWidth: 200.00,
        scale: 1.00,
        scaleMobile: 1.00,
        color: "#3b82f6",
        backgroundColor: "#f8fafc",
        size: 0.8
      });
    } catch(e) {}

    feather.replace();

    // --- Utilities ---
    const qs = (s, p=document)=>p.querySelector(s);
    const qsa = (s, p=document)=>Array.from(p.querySelectorAll(s));
    const debounce = (fn, d=300)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d);} };
    const copy = async (text)=>{ try { await navigator.clipboard.writeText(text); alert('Copied'); } catch(e){ prompt('Copy to clipboard:', text); } };
    const uniq = (arr)=>Array.from(new Set(arr).values());
    const toCsv = (rows)=>{
      const headers = Object.keys(rows[0]||{});
      const esc = v => ('"'+String(v).replace(/"/g,'""')+'"');
      return [headers.join(','),
        ...rows.map(r=>headers.map(h=>esc(Array.isArray(r[h])?r[h].join('; '): (r[h]??'')).join(',')))
      ].join('\\n');
    };
    const setQuery = (obj)=>{
      const params = new URLSearchParams(obj);
      history.replaceState(null,'', location.pathname + '?' + params.toString());
    };
    const getQuery = ()=>Object.fromEntries(new URLSearchParams(location.search).entries());

    // --- State ---
    let ALL = [];
    let filtered = [];
    let favorites = new Set(JSON.parse(localStorage.getItem('np_favs')||'[]'));
    let sel = new Set();
    let sortKey = 'name';
    let sortDir = 'asc';
    let page = 1;
    let pageSize = parseInt(localStorage.getItem('np_page_size')||'25',10);

    const filters = {
      states: [],
      payers: [],
      creds: [],
      search: '',
      inNet: false
    };

    // --- Load data ---
    async function loadData(){
      try{
        const res = await fetch('/data/np_roster.json', {cache:'no-store'});
        if(!res.ok) throw new Error('no file');
        ALL = await res.json();
      } catch(e){
        // fallback sample
        qs('#warn').classList.remove('hidden');
        ALL = [{"id": "uuid-1", "firstName": "Ellen", "lastName": "Neylon", "email": "ellen.neylon@gmail.com", "mobile": "(646) 338-5975", "credential": "FNP-BC", "states": ["NV", "NY"], "personalNPI": "1234567890", "payers": ["Medicare", "Aetna", "UHC", "BCBS"], "availability": "Weekdays AM", "inNetworkConfirmed": true}, {"id": "uuid-2", "firstName": "Sophia", "lastName": "Cabrera", "email": "sdcabrera85@gmail.com", "mobile": "(702) 339-2915", "credential": "APRN-FNP", "states": ["NV"], "personalNPI": "2345678901", "payers": ["UHC", "Cigna"], "availability": "Flexible", "inNetworkConfirmed": true}, {"id": "uuid-3", "firstName": "Anthony", "lastName": "Opimo", "email": "aopimo@me.com", "mobile": "(702) 849-2504", "credential": "AGACNP-BC", "states": ["NV"], "personalNPI": "3456789012", "payers": ["Medicare", "BCBS"], "availability": "Weekdays PM", "inNetworkConfirmed": true}, {"id": "uuid-4", "firstName": "David", "lastName": "Preston", "email": "davidprestonarnp@gmail.com", "mobile": "(727) 804-3360", "credential": "NP-C", "states": ["FL"], "personalNPI": "4567890123", "payers": ["Medicare", "Aetna", "Cigna"], "availability": "Mid-day", "inNetworkConfirmed": true}];
      }
      normalize();
      hydrateFilterOptions();
      applyQueryToFilters();
      applyFilters();
      render();
    }

    function normalize(){
      ALL = ALL.map(x=>{
        const name = (x.firstName||'') + ' ' + (x.lastName||'');
        const states = (x.states||[]).filter(Boolean);
        const payers = (x.payers||[]).filter(Boolean);
        return {
          id: x.id || (window.crypto?.randomUUID ? crypto.randomUUID() : (Math.random()+''+Date.now())),
          firstName: x.firstName||'',
          lastName: x.lastName||'',
          email: x.email||'',
          mobile: x.mobile||'',
          credential: x.credential||'',
          states,
          personalNPI: x.personalNPI||'',
          payers,
          availability: x.availability||'',
          inNetworkConfirmed: !!x.inNetworkConfirmed,
          name,
          statesCount: states.length,
          payersCount: payers.length
        };
      });
    }

    function hydrateFilterOptions(){
      const states = uniq(ALL.flatMap(x=>x.states)).sort();
      const payers = uniq(ALL.flatMap(x=>x.payers)).sort();
      const creds  = uniq(ALL.map(x=>x.credential).filter(Boolean)).sort();
      const makeChip = (label, value, group)=>{
        const btn = document.createElement('button');
        btn.className = 'chip';
        btn.dataset.value = value;
        btn.dataset.group = group;
        btn.innerHTML = '<i data-feather="check-circle" class="mr-1"></i>'+label;
        btn.addEventListener('click', ()=>{
          const arr = filters[group];
          const idx = arr.indexOf(value);
          if(idx>=0) arr.splice(idx,1); else arr.push(value);
          renderFilterChips();
          applyFilters();
          render();
        });
        return btn;
      };
      const sf = qs('#stateFilter'); sf.innerHTML='';
      states.forEach(s=> sf.appendChild(makeChip(s,s,'states')));
      const pf = qs('#payerFilter'); pf.innerHTML='';
      payers.forEach(p=> pf.appendChild(makeChip(p,p,'payers')));
      const cf = qs('#credFilter'); cf.innerHTML='';
      creds.forEach(c=> cf.appendChild(makeChip(c,c,'creds')));
      feather.replace();
    }

    function renderFilterChips(){
      ['stateFilter','payerFilter','credFilter'].forEach(id=>{
        qsa('#'+id+' .chip').forEach(el=>{
          const group = el.dataset.group;
          const val = el.dataset.value;
          if(filters[group].includes(val)){
            el.classList.add('ring-2','ring-primary-500');
          } else {
            el.classList.remove('ring-2','ring-primary-500');
          }
        });
      });
      const q = {};
      if(filters.states.length) q.states = filters.states.join(',');
      if(filters.payers.length) q.payers = filters.payers.join(',');
      if(filters.creds.length)  q.creds  = filters.creds.join(',');
      if(filters.search) q.search = filters.search;
      if(filters.inNet) q.inNet = '1';
      setQuery(q);
    }

    function applyQueryToFilters(){
      const q = getQuery();
      if(q.states) filters.states = q.states.split(',').filter(Boolean);
      if(q.payers) filters.payers = q.payers.split(',').filter(Boolean);
      if(q.creds)  filters.creds  = q.creds.split(',').filter(Boolean);
      if(q.search) { filters.search = q.search; qs('#search').value = filters.search; }
      if(q.inNet==='1'){ filters.inNet = true; qs('#inNet').checked = true; }
      renderFilterChips();
    }

    function applyFilters(){
      const s = filters.search.toLowerCase().trim();
      filtered = ALL.filter(x=>{
        if(filters.inNet && !x.inNetworkConfirmed) return false;
        if(filters.states.length && !filters.states.some(st=>x.states.includes(st))) return false;
        if(filters.payers.length && !filters.payers.some(py=>x.payers.includes(py))) return false;
        if(filters.creds.length && !filters.creds.includes(x.credential)) return false;
        if(s){
          const hay = (x.name+' '+x.email+' '+x.personalNPI).toLowerCase();
          if(!hay.includes(s)) return false;
        }
        return true;
      });
      filtered.sort((a,b)=>{
        let A=a[sortKey], B=b[sortKey];
        if(Array.isArray(A)) A=A.length;
        if(Array.isArray(B)) B=B.length;
        if(typeof A==='string') A=A.toLowerCase();
        if(typeof B==='string') B=B.toLowerCase();
        if(A<B) return sortDir==='asc'?-1:1;
        if(A>B) return sortDir==='asc'?1:-1;
        return 0;
      });
      const maxPage = Math.max(1, Math.ceil(filtered.length / pageSize));
      if(page>maxPage) page = maxPage;
      qs('#countLabel').textContent = `Showing ${filtered.length} provider${filtered.length===1?'':'s'}`;
      renderStats();
    }

    function renderStats(){
      const total = ALL.length;
      const st = uniq(ALL.flatMap(x=>x.states)).length;
      const py = uniq(ALL.flatMap(x=>x.payers)).length;
      const fav = favorites.size;
      const cards = [
        {label:'Total Providers', value: total},
        {label:'States Covered', value: st},
        {label:'Unique Payers', value: py},
        {label:'Favorites', value: fav}
      ];
      const wrap = qs('#stats'); wrap.innerHTML='';
      cards.forEach(c=>{
        const d = document.createElement('div');
        d.className = 'bg-white shadow rounded-lg p-4';
        d.innerHTML = `<div class="text-sm text-gray-500">${c.label}</div>
                       <div class="text-2xl font-semibold">${c.value}</div>`;
        wrap.appendChild(d);
      });
    }

    function render(){
      const tbody = qs('#tbody'); tbody.innerHTML='';
      const start = (page-1)*pageSize;
      const rows = filtered.slice(start, start+pageSize);
      rows.forEach(x=>{
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 cursor-pointer';
        tr.addEventListener('click', (e)=>{
          if(e.target.closest('input,button,svg,path')) return;
          openDrawer(x);
        });
        const checked = sel.has(x.id) ? 'checked' : '';
        const star = favorites.has(x.id) ? 'text-yellow-500' : 'text-gray-300';
        tr.innerHTML = `
          <td class="px-3 py-3"><input data-id="${x.id}" type="checkbox" class="rowSel rounded border-gray-300 text-primary-600 focus:ring-primary-500" ${checked}></td>
          <td class="px-6 py-3">
            <div class="flex items-center space-x-2">
              <button title="Favorite" class="favBtn" data-id="${x.id}"><i data-feather="star" class="${star}"></i></button>
              <div>
                <div class="font-medium text-gray-900">${x.firstName} ${x.lastName} <span class="text-gray-500 text-xs ml-1">${x.credential||''}</span></div>
                <div class="text-xs text-gray-500">${x.email}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-3">
            ${x.states.map(s=>`<span class="badge mr-1">${s}</span>`).join('')}
          </td>
          <td class="px-6 py-3">${x.personalNPI}</td>
          <td class="px-6 py-3">
            ${x.payers.map(p=>`<span class="badge mr-1">${p}</span>`).join('')}
          </td>
          <td class="px-6 py-3">${x.email}</td>
          <td class="px-6 py-3">${x.mobile||''}</td>
          <td class="px-6 py-3">${x.availability||''}</td>
          <td class="px-6 py-3 text-right space-x-2">
            <button class="copyNpi px-2 py-1 border rounded text-sm" data-npi="${x.personalNPI}">Copy NPI</button>
            <button class="copyEmail px-2 py-1 border rounded text-sm" data-email="${x.email}">Copy Email</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      feather.replace();

      const total = filtered.length;
      const startIdx = total? start+1 : 0;
      const endIdx = Math.min(start+pageSize, total);
      qs('#rangeLabel').textContent = `${startIdx}-${endIdx} of ${total}`;
      qs('#prevPage').disabled = page===1;
      qs('#nextPage').disabled = endIdx>=total;

      qsa('.rowSel').forEach(cb=>cb.addEventListener('click', (e)=>{
        e.stopPropagation();
        const id = e.currentTarget.dataset.id;
        if(e.currentTarget.checked) sel.add(id); else sel.delete(id);
      }));
      qsa('.favBtn').forEach(btn=>btn.addEventListener('click',(e)=>{
        e.stopPropagation();
        const id = e.currentTarget.dataset.id;
        if(favorites.has(id)) favorites.delete(id); else favorites.add(id);
        localStorage.setItem('np_favs', JSON.stringify(Array.from(favorites)));
        render();
      }));
      qsa('.copyNpi').forEach(b=>b.addEventListener('click', (e)=>{
        e.stopPropagation(); copy(e.currentTarget.dataset.npi);
      }));
      qsa('.copyEmail').forEach(b=>b.addEventListener('click', (e)=>{
        e.stopPropagation(); copy(e.currentTarget.dataset.email);
      }));

      qsa('th.sortable').forEach(th=>{
        th.classList.toggle('active', th.dataset.key===sortKey);
        th.onclick = ()=>{
          const key = th.dataset.key;
          if(sortKey===key){ sortDir = (sortDir==='asc'?'desc':'asc'); }
          else { sortKey = key; sortDir = 'asc'; }
          applyFilters();
          render();
        };
      });
    }

    function openDrawer(x){
      const d = qs('#drawer'); const b = qs('#drawerBody');
      b.innerHTML = `
        <div class="flex items-center justify-between">
          <div>
            <div class="text-lg font-semibold">${x.firstName} ${x.lastName} <span class="text-gray-500 text-sm">${x.credential||''}</span></div>
            <div class="text-sm text-gray-500">${x.email} • ${x.mobile||''}</div>
          </div>
          <div class="space-x-2">
            <button class="px-3 py-1.5 border rounded text-sm" onclick="navigator.clipboard.writeText('${x.personalNPI}')">Copy NPI</button>
            <button class="px-3 py-1.5 border rounded text-sm" onclick="navigator.clipboard.writeText('${x.email}')">Copy Email</button>
            <button class="px-3 py-1.5 border rounded text-sm" onclick="navigator.clipboard.writeText('${x.mobile||''}')">Copy Phone</button>
          </div>
        </div>
        <div>
          <div class="text-sm font-medium text-gray-700 mt-4 mb-1">States</div>
          <div>${x.states.map(s=>`<span class="chip">${s}</span>`).join('')}</div>
        </div>
        <div>
          <div class="text-sm font-medium text-gray-700 mt-4 mb-1">Payers</div>
          <div>${x.payers.map(p=>`<span class="chip">${p}</span>`).join('')}</div>
        </div>
        <div class="text-sm text-gray-600 mt-4">Availability: <span class="font-medium text-gray-800">${x.availability||'—'}</span></div>
        <div class="text-sm text-gray-600">Personal NPI: <span class="font-medium text-gray-800">${x.personalNPI}</span></div>
        <div class="text-sm text-gray-600">In‑network confirmed: <span class="font-medium ${x.inNetworkConfirmed?'text-green-700':'text-yellow-700'}">${x.inNetworkConfirmed?'Yes':'Unconfirmed'}</span></div>
      `;
      d.classList.remove('drawer-closed');
      d.setAttribute('aria-hidden','false');
      document.addEventListener('keydown', escClose);
    }
    function closeDrawer(){
      const d = qs('#drawer');
      d.classList.add('drawer-closed');
      d.setAttribute('aria-hidden','true');
      document.removeEventListener('keydown', escClose);
    }
    function escClose(e){ if(e.key==='Escape') closeDrawer(); }

    qs('#closeDrawer').addEventListener('click', closeDrawer);
    qs('#prevPage').addEventListener('click', ()=>{ page=Math.max(1,page-1); render(); });
    qs('#nextPage').addEventListener('click', ()=>{ const max=Math.ceil(filtered.length/pageSize); page=Math.min(max,page+1); render(); });
    qs('#pageSize').value = String(pageSize);
    qs('#pageSize').addEventListener('change', (e)=>{
      pageSize = parseInt(e.target.value,10);
      localStorage.setItem('np_page_size', String(pageSize));
      page = 1;
      render();
    });
    qs('#selAll').addEventListener('change', (e)=>{
      const start=(page-1)*pageSize;
      const rows=filtered.slice(start, start+pageSize);
      if(e.target.checked){ rows.forEach(r=>sel.add(r.id)); } else { rows.forEach(r=>sel.delete(r.id)); }
      render();
    });
    qs('#clearFilters').addEventListener('click', ()=>{
      filters.states=[]; filters.payers=[]; filters.creds=[]; filters.search=''; filters.inNet=false;
      qs('#search').value=''; qs('#inNet').checked=false; renderFilterChips(); applyFilters(); page=1; render();
    });
    qs('#inNet').addEventListener('change', (e)=>{ filters.inNet = e.target.checked; applyFilters(); page=1; render(); });
    qs('#search').addEventListener('input', debounce((e)=>{ filters.search=e.target.value; renderFilterChips(); applyFilters(); page=1; render(); },300));

    qs('#bulkCopyEmails').addEventListener('click', ()=>{
      const chosen = sel.size ? ALL.filter(x=>sel.has(x.id)) : filtered;
      const list = chosen.map(x=>x.email).filter(Boolean).join('; ');
      if(!list) return alert('No emails to copy.');
      copy(list);
    });
    qs('#bulkExportCsv').addEventListener('click', ()=>{
      const chosen = sel.size ? ALL.filter(x=>sel.has(x.id)) : filtered;
      if(!chosen.length) return alert('No rows to export.');
      const rows = chosen.map(({id,firstName,lastName,email,mobile,credential,states,personalNPI,payers,availability,inNetworkConfirmed})=>({
        id,firstName,lastName,email,mobile,credential,states:states.join('|'),personalNPI,payers:payers.join('|'),availability,inNetworkConfirmed
      }));
      const csv = [
        'id,firstName,lastName,email,mobile,credential,states,personalNPI,payers,availability,inNetworkConfirmed',
        ...rows.map(r => [
          r.id, r.firstName, r.lastName, r.email, r.mobile, r.credential, r.states, r.personalNPI, r.payers, r.availability, r.inNetworkConfirmed
        ].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))
      ].join('\\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='np_roster_export.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // CSV modal (simple merge)
    const csvModal = qs('#csvModal');
    qs('#importCsvBtn').addEventListener('click', ()=>{ csvModal.classList.remove('hidden'); });
    qs('#closeCsv').addEventListener('click', ()=>{ csvModal.classList.add('hidden'); });
    qs('#importCsv').addEventListener('click', async ()=>{
      const f = qs('#csvFile').files[0];
      if(!f) return alert('Choose a CSV file first.');
      const text = await f.text();
      const lines = text.split(/\\r?\\n/).filter(Boolean);
      const [header, ...rows] = lines;
      const cols = header.split(',');
      const idx = (k)=> cols.indexOf(k);
      function val(parts, key){
        const i = idx(key); return i>=0 ? parts[i] : '';
      }
      const add = [];
      for(const line of rows){
        const parts = line.match(/("([^"]|"")*"|[^,]+)/g) || []; // csv-safe split
        if(!parts.length) continue;
        const rec = {
          id: crypto.randomUUID(),
          firstName: (val(parts,'firstName')||'').replace(/^"|"$/g,''),
          lastName:  (val(parts,'lastName')||'').replace(/^"|"$/g,''),
          email:     (val(parts,'email')||'').replace(/^"|"$/g,''),
          mobile:    (val(parts,'mobile')||'').replace(/^"|"$/g,''),
          credential:(val(parts,'credential')||'').replace(/^"|"$/g,''),
          states:    (val(parts,'states')||'').replace(/^"|"$/g,'').split('|').filter(Boolean),
          personalNPI:(val(parts,'personalNPI')||'').replace(/^"|"$/g,''),
          payers:    (val(parts,'payers')||'').replace(/^"|"$/g,'').split('|').filter(Boolean),
          availability:(val(parts,'availability')||'').replace(/^"|"$/g,''),
          inNetworkConfirmed:/^(true|1|yes)$/i.test((val(parts,'inNetworkConfirmed')||'').replace(/^"|"$/g,''))
        };
        add.push(rec);
      }
      ALL = ALL.concat(add);
      normalize();
      hydrateFilterOptions();
      applyFilters();
      render();
      csvModal.classList.add('hidden');
    });

    loadData();
  </script>
</body>
</html>
